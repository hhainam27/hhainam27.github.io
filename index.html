<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Random Manga Redirect</title>
  <style>
    body {
      background: #0f0f0f;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding-top: 20vh;
    }
    h1 {
      color: #f472b6;
      text-shadow: 0 0 10px #f472b6;
    }
    button {
      padding: 1em 2em;
      font-size: 1rem;
      cursor: pointer;
      background-color: #f472b6;
      color: white;
      border: none;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(244,114,182,0.5);
    }
  </style>
</head>
<body>
  <h1>🎲 Đang chọn manga ngẫu nhiên...</h1>
  <p>Nếu lâu, vui lòng nhấn nút bên dưới:</p>
  <button id="retryBtn" style="display:none;">Chọn lại</button>

  <script>
   function waitForElm(selector) {
  return new Promise((resolve) => {
    if (document.querySelector(selector)) {
      return resolve(document.querySelector(selector));
    }

    const observer = new MutationObserver(() => {
      if (document.querySelector(selector)) {
        observer.disconnect();
        resolve(document.querySelector(selector));
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  });
}

waitForElm("body").then(() => {
  let fetchedMangas = [];
  const perPage = 50;
  let currentPage = 1;
  let totalPages = null;

  async function redirectRandomManga(page = 1) {
    const originUrl = `https://cuutruyen.net/api/v2/teams/485/mangas/recently_updated?page=${page <= 0 ? 1 : page}&per_page=${perPage <= 0 ? 1 : perPage}`;
    const url = `https://cors-proxy.boydaihungst.workers.dev/?url=${encodeURIComponent(originUrl)}`;

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error("HTTP error " + response.status);
      const json = await response.json();

      if (totalPages === null) {
        totalPages = json._metadata.total_pages;
        const randomPage = Math.floor(Math.random() * totalPages) + 1;
        await redirectRandomManga(randomPage);
      } else {
        fetchedMangas = json.data;
        const randomManga =
          fetchedMangas[Math.floor(Math.random() * fetchedMangas.length) + 1];
        if (randomManga) {
          const mangaUrl = `https://cuutruyen.net/mangas/${randomManga.id}`;
          window.location.href = mangaUrl;
        }
      }
    } catch (err) {
      console.error("❌ Error fetching page:", err);
      document.body.innerHTML =
        '<h2 style="color: red; text-align: center;">Không thể tải danh sách manga</h2>';
    }
  }

  // Retry button
  waitForElm("#retryBtn").then((btn) => {
    btn.style.display = "inline-block";
    btn.addEventListener("click", () => location.reload());
  })

  redirectRandomManga();
});
</script>
</body>
</html>
